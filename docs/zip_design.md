# ZIPファイル設計書

## 目次
1. [概要](#1-概要)
2. [ファイル構造](#2-ファイル構造)
3. [ファイル仕様](#3-ファイル仕様)
4. [セキュリティ仕様](#4-セキュリティ仕様)
5. [バージョン管理](#5-バージョン管理)
6. [エラーハンドリング](#6-エラーハンドリング)
7. [テスト仕様](#7-テスト仕様)
8. [バージョン履歴](#8-バージョン履歴)

## 8. バージョン履歴
| バージョン | 日付       | 変更内容                     | 担当者 |
|------------|------------|------------------------------|--------|
| 1.0.0      | 2023-01-01 | 初版作成                     | Cline  |
| 1.1.0      | 2023-01-02 | セキュリティ仕様詳細化       | Cline  |
| 1.2.0      | 2023-01-02 | エラーハンドリング詳細化     | Cline  |
| 1.3.0      | 2023-01-02 | テスト仕様詳細化             | Cline  |
| 1.4.0      | 2023-01-02 | 目次とバージョン履歴追加     | Cline  |

## 1. 概要
試験データと結果データをZIPファイル形式でやり取りするための仕様書。API通信の代わりにファイルベースのデータ交換を行う。

## 2. ファイル構造

### 2.1 試験データZIP
```
exam_data.zip
├── manifest.json
├── exam/
│   ├── exam_meta.json
│   ├── questions/
│   │   ├── 1.json
│   │   ├── 2.json
│   │   └── ...
│   └── assets/
│       ├── images/
│       └── audios/
└── signature.sha256
```

### 2.2 結果データZIP
```
exam_result.zip
├── manifest.json
├── result/
│   ├── exam_meta.json
│   ├── answers.json
│   ├── statistics.json
│   └── logs/
│       ├── system.log
│       └── user_actions.log
└── signature.sha256
```

## 3. ファイル仕様

### 3.1 manifest.json
```json
{
  "version": "1.0.0",
  "created_at": "2023-01-01T00:00:00Z",
  "exam_id": "exam-123",
  "hash_algorithm": "SHA-256",
  "encryption": {
    "algorithm": "AES-256",
    "key_version": "v1"
  }
}
```

### 3.2 exam_meta.json
```json
{
  "id": "exam-123",
  "title": "Sample Exam",
  "description": "This is a sample exam",
  "time_limit": 60,
  "passing_score": 70,
  "created_at": "2023-01-01T00:00:00Z",
  "updated_at": "2023-01-01T00:00:00Z"
}
```

### 3.3 question.json
```json
{
  "id": "question-1",
  "type": "single",
  "text": "What is 2+2?",
  "options": ["1", "2", "3", "4"],
  "correct_answer": "4",
  "explanation": "Basic arithmetic",
  "weight": 1.0
}
```

### 3.4 answers.json
```json
{
  "exam_id": "exam-123",
  "start_time": "2023-01-01T00:00:00Z",
  "end_time": "2023-01-01T01:00:00Z",
  "answers": {
    "question-1": "4",
    "question-2": ["A", "C"]
  }
}
```

## 4. セキュリティ仕様

### 4.1 暗号化仕様
- アルゴリズム: AES-256-GCM（認証付き暗号化）
- 鍵管理:
  - 鍵生成: 256ビットランダム値
  - 鍵配布: 安全なチャネル経由（例：QRコード）
  - 鍵更新: 試験ごとに新規生成
  - 鍵保管: ローカルストレージに暗号化保存
  - 鍵使用制限: 1回限りの使用
- 初期化ベクトル: 96ビットランダム値（試験ごとに新規生成）
- 追加保護:
  - ファイルごとの固有鍵
  - メタデータ暗号化
  - タイムスタンプ検証
  - 編集用パスワード保護（オプション）
    - パスワードハッシュ: bcrypt
    - ソルト: 128ビットランダム値
    - パスワード強度: 最低8文字、大文字小文字数字必須
- 編集機能:
  - 既存問題の読み込み
  - 部分的な問題の更新
  - バージョン管理
  - 変更履歴の記録

### 4.2 整合性チェック
- ファイル構造:
  - マニフェストファイルの必須項目検証
  - 必須ファイルの存在確認
- データ整合性:
  - 各ファイルのSHA-256ハッシュ値検証
  - マニフェスト記載のハッシュ値と比較
- 署名検証:
  - RSA 2048ビット署名
  - 公開鍵による検証
  - 署名対象: マニフェストファイル + 全ファイルのハッシュ値

### 4.3 セキュリティチェック
- 定期的なチェック項目:
  - 暗号化設定の確認
  - 鍵のバックアップ状態
  - ログの保存状況
  - 依存ライブラリのセキュリティアップデート確認
- チェック頻度: 必要に応じて随時

## 5. バージョン管理
- メジャーバージョン変更：互換性のない変更
- マイナーバージョン変更：後方互換性のある変更
- パッチバージョン変更：バグ修正

## 6. エラーハンドリング

### 6.1 エラーコード体系
| コード範囲 | カテゴリ           | 例                      |
|------------|--------------------|-------------------------|
| 1000-1099  | ファイル関連       | 1000: ファイル破損      |
| 1100-1199  | 暗号化関連         | 1101: 復号化失敗        |
| 1200-1299  | 整合性関連         | 1201: ハッシュ不一致    |
| 1300-1399  | バージョン関連     | 1301: 互換性エラー      |
| 1400-1499  | システム関連       | 1401: メモリ不足        |

### 6.2 エラーログ仕様
```json
{
  "timestamp": "2023-01-01T00:00:00Z",
  "level": "ERROR",
  "code": 1000,
  "message": "File corruption detected",
  "details": {
    "file": "exam_meta.json",
    "expected_size": "1024",
    "actual_size": "0"
  },
  "context": {
    "exam_id": "exam-123",
    "user_id": "user-456",
    "client_version": "1.2.3"
  }
}
```

### 6.3 リカバリプロセス
1. 自動リカバリ
   - バックアップファイルの検索
   - 整合性チェックの再試行
   - キャッシュのクリア

2. 手動リカバリ
   - ログ分析
   - ファイル修復ツールの実行
   - 管理者通知

3. フォールバック
   - 前バージョンへのロールバック
   - 代替データソースの使用
   - 緊急モードでの動作

### 6.4 監視とアラート
- 監視項目:
  - エラー発生率
  - リカバリ成功率
  - 処理時間
- アラート条件:
  - 連続エラー発生
  - リカバリ失敗
  - パフォーマンス低下
- 通知方法:
  - メール/SMS
  - 監視ダッシュボード
  - ログ集約システム

## 7. テスト仕様

### 7.1 単体テスト
#### 7.1.1 ファイル構造検証
- 必須ファイルの存在確認
- ディレクトリ構造の検証
- ファイルパーミッションの確認

#### 7.1.2 データ整合性
- ハッシュ値の検証
- ファイルサイズの確認
- データフォーマットの検証

#### 7.1.3 暗号化/復号化
- 暗号化アルゴリズムの検証
- 復号化の正常系/異常系テスト
- パフォーマンス測定

### 7.2 結合テスト
#### 7.2.1 試験データ読み込み
- 正常系: 完全なデータセット
- 異常系: 欠損データ
- 境界値: 最小/最大サイズ

#### 7.2.2 結果データ書き出し
- データ完全性の検証
- パフォーマンス測定
- エラー発生時の挙動確認

#### 7.2.3 バージョン互換性
- 上位互換性テスト
- 下位互換性テスト
- バージョン不一致時の挙動

### 7.3 パフォーマンステスト
#### 7.3.1 テストデータ仕様
| データサイズ | ファイル数 | 試験問題数 | 想定ユーザー数 |
|--------------|------------|------------|----------------|
| 10MB         | 10         | 50         | 100            |
| 100MB        | 50         | 500        | 1,000          |
| 1GB          | 200        | 5,000      | 10,000         |

#### 7.3.2 測定項目
- 読み込み時間
- 書き出し時間
- メモリ使用量
- CPU使用率

#### 7.3.3 パフォーマンス目標
| 指標         | 目標値               |
|--------------|----------------------|
| 読み込み時間 | 100MB: < 1秒         |
| 書き出し時間 | 100MB: < 2秒         |
| メモリ使用量 | データサイズの1.5倍以下 |
| CPU使用率    | 平均70%以下          |

### 7.4 自動テスト
#### 7.4.1 テストフレームワーク
- Jest + TypeScript
- カバレッジ目標: 90%以上
- テスト実行時間: 5分以内

#### 7.4.2 CI/CD統合
- GitHub Actionsによる自動実行
- テスト失敗時の通知
- カバレッジレポートの自動生成

#### 7.4.3 モニタリング
- テスト実行履歴の保存
- パフォーマンストレンドの可視化
- エラー発生率の監視
